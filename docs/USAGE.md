# DeepSpider 使用指南

> 智能爬虫 Agent - 加密场景分析指南

## 快速开始

### 1. 启动 Agent

```bash
pnpm run agent
```

### 2. 基本流程

```
启动浏览器 → 注入Hook → 访问目标 → 触发请求 → 分析日志 → 定位源码 → 提取逻辑
```

---

## 场景一：Headers 动态加密

**适用于：** X-Sign、X-Token、Authorization 等动态签名

### 操作步骤

**第一步：启动浏览器并注入 Hook**

```
请启动浏览器，注入网络和加密 Hook
```

Agent 会执行：
- `launch_browser` - 启动浏览器
- `generate_xhr_hook` / `generate_fetch_hook` - 生成网络 Hook
- `generate_cryptojs_hook` - 生成加密 Hook

**第二步：访问目标网站**

```
访问 https://example.com
```

**第三步：触发目标请求**

```
点击登录按钮触发请求
```

或使用工具：
```
请点击页面上的登录按钮
```

**第四步：分析加密来源**

```
分析 X-Sign 这个 Header 是如何生成的
```

Agent 会：
1. 获取日志 `__deepspider__.getAllLogs()`
2. 调用 `analyze_header_encryption` 分析
3. 调用 `locate_crypto_source` 定位源码

**第五步：提取加密逻辑**

```
提取生成 X-Sign 的加密函数代码
```

---

## 场景二：Cookie 动态加密

**适用于：** 反爬虫 Cookie、__jsl_clearance、acw_sc__v2 等

### 操作步骤

**第一步：启动浏览器，页面加载前注入 Hook**

```
启动浏览器，需要在页面加载前注入 Hook 来捕获 Cookie 生成
```

Agent 会使用 `add_init_script` 在页面加载前注入。

**第二步：清除 Cookie 并访问**

```
清除 Cookie 后访问 https://example.com，触发 Cookie 生成
```

**第三步：分析 Cookie 来源**

```
分析 __token__ 这个 Cookie 是如何生成的
```

Agent 会调用 `analyze_cookie_encryption` 分析。

**第四步：提取生成逻辑**

```
提取生成该 Cookie 的完整代码
```

---

## 场景三：请求参数加密

**适用于：** POST Body 加密、查询参数加密

### 操作步骤

**第一步：注入 Hook 并触发请求**

```
启动浏览器，访问目标网站，触发登录请求
```

**第二步：分析加密参数**

```
分析请求体中的加密参数是如何生成的
```

Agent 会：
1. 从 `linkedCrypto` 找到关联的加密调用
2. 定位加密函数

**第三步：提取加密逻辑**

```
提取参数加密的函数，我需要在 Node.js 中复现
```

---

## 场景四：响应结果加密

**适用于：** 接口返回加密数据

### 操作步骤

**第一步：注入 Hook 并触发请求**

```
启动浏览器，访问目标网站，触发数据请求
```

**第二步：分析解密逻辑**

```
分析响应数据是如何解密的
```

Agent 会调用 `analyze_response_decryption` 分析。

**第三步：提取解密逻辑**

```
提取解密函数代码
```

---

## 常用命令参考

### 浏览器操作

| 命令 | 说明 |
|------|------|
| 启动浏览器 | 启动并注入基础 Hook |
| 访问 URL | 导航到指定页面 |
| 点击 XXX | 点击页面元素 |
| 截图 | 保存当前页面截图 |
| 关闭浏览器 | 关闭浏览器释放资源 |

### 分析操作

| 命令 | 说明 |
|------|------|
| 分析 Header XXX | 分析指定 Header 的加密来源 |
| 分析 Cookie XXX | 分析指定 Cookie 的生成逻辑 |
| 分析请求加密 | 分析请求参数的加密方式 |
| 分析响应解密 | 分析响应数据的解密方式 |

### 调试操作

| 命令 | 说明 |
|------|------|
| 设置断点 | 在指定位置设置断点 |
| 设置 XHR 断点 | 拦截指定 URL 的请求 |
| 查看调用栈 | 查看当前断点的调用栈 |
| 查看变量 | 查看当前作用域的变量 |

### 提取操作

| 命令 | 说明 |
|------|------|
| 提取函数 XXX | 提取指定函数的代码 |
| 列出所有函数 | 列出代码中的函数列表 |

---

## 沙箱验证

提取代码后，可以在沙箱中验证：

```
在沙箱中执行以下代码验证加密结果：
[粘贴提取的代码]
```

如果报错缺少环境：

```
自动补全缺失的环境并重新执行
```

Agent 会：
1. 分析缺失的环境属性
2. 从真实浏览器采集
3. 生成补丁代码
4. 重新执行验证
