<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>JSForge Panel</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      padding: 12px 16px;
      background: #2d2d2d;
      border-bottom: 1px solid #3c3c3c;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-title { font-weight: 600; color: #4fc3f7; font-size: 14px; }
    .header-btns button {
      background: none; border: none;
      color: #808080; font-size: 14px;
      cursor: pointer; margin-left: 8px;
      padding: 4px 8px;
    }
    .header-btns button:hover { color: #fff; }
    .header-btns button.active { color: #4fc3f7; background: #3c3c3c; border-radius: 4px; }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .msg {
      margin-bottom: 10px;
      padding: 10px 12px;
      border-radius: 6px;
      line-height: 1.5;
      word-break: break-word;
      white-space: pre-wrap;
      font-size: 13px;
    }
    .msg-user { background: #094771; margin-left: 40px; }
    .msg-assistant { background: #2d2d2d; margin-right: 40px; }
    .msg-system { background: #3c3c3c; text-align: center; font-size: 12px; color: #808080; }
    .input-area {
      padding: 12px;
      border-top: 1px solid #3c3c3c;
      display: flex;
      gap: 8px;
    }
    .input-area textarea {
      flex: 1;
      padding: 10px;
      background: #2d2d2d;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      color: #d4d4d4;
      resize: none;
      font-size: 13px;
      font-family: inherit;
    }
    .input-area textarea:focus { outline: none; border-color: #4fc3f7; }
    .input-area button {
      padding: 10px 16px;
      background: #4fc3f7;
      border: none;
      border-radius: 4px;
      color: #1e1e1e;
      cursor: pointer;
      font-weight: 500;
    }
    .input-area button:hover { background: #81d4fa; }
  </style>
</head>
<body>
  <div class="header">
    <span class="header-title">JSForge</span>
    <div class="header-btns">
      <button id="btn-select" title="选择元素">⦿ 选择</button>
      <button id="btn-clear" title="清空消息">清空</button>
    </div>
  </div>
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <textarea id="chat-input" placeholder="输入问题..." rows="2"></textarea>
    <button id="btn-send">发送</button>
  </div>
  <script>
    const messages = [];
    const messagesEl = document.getElementById('messages');
    const chatInput = document.getElementById('chat-input');

    function escapeHtml(str) {
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function renderMessages() {
      messagesEl.innerHTML = messages.map(m =>
        '<div class="msg msg-' + m.role + '">' + escapeHtml(m.content) + '</div>'
      ).join('');
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addMessage(role, content) {
      messages.push({ role, content, time: Date.now() });
      renderMessages();
    }

    // 暴露给后端调用
    window.__panel__ = {
      addMessage,
      clearMessages: () => { messages.length = 0; renderMessages(); }
    };

    // 发送消息
    function sendChat() {
      const text = chatInput.value.trim();
      if (!text) return;
      chatInput.value = '';
      addMessage('user', text);
      if (typeof __jsforge_send__ === 'function') {
        __jsforge_send__(JSON.stringify({ type: 'chat', text }));
      }
    }

    document.getElementById('btn-send').onclick = sendChat;
    chatInput.onkeydown = (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
    };

    // 选择模式
    document.getElementById('btn-select').onclick = () => {
      if (typeof __jsforge_send__ === 'function') {
        __jsforge_send__(JSON.stringify({ type: 'start-select' }));
      }
    };

    // 清空
    document.getElementById('btn-clear').onclick = () => {
      messages.length = 0;
      renderMessages();
    };

    addMessage('system', '面板已就绪，点击「选择」按钮选择页面元素进行分析');
  </script>
</body>
</html>
