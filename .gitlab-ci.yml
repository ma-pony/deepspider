# GitLab CI/CD 配置 - npm 自动发布
# 触发条件：推送 v* 标签时自动发布到 npm

stages:
  - test
  - publish

variables:
  NODE_VERSION: "20"

# 缓存 node_modules
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

# 测试任务
test:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - npm install -g pnpm
    - pnpm install
  script:
    - pnpm lint
    - pnpm test
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

# 发布到 npm
publish:
  stage: publish
  image: node:${NODE_VERSION}
  before_script:
    - npm install -g pnpm
    - pnpm install
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
  script:
    - npm publish
  after_script:
    - rm -f ~/.npmrc
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  needs:
    - test
